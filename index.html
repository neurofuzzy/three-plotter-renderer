<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>Primitives Hatching Test</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-dark: #1a1a2e;
            --bg-panel: rgba(22, 33, 62, 0.92);
            --bg-section: rgba(0, 0, 0, 0.25);
            --accent: #0f3460;
            --accent-primary: #2d8a5a;
            --accent-hover: #e94560;
            --text: #eaeaea;
            --text-muted: #8a8a9a;
            --text-heading: #ffffff;
            --border: rgba(255, 255, 255, 0.08);
            --border-light: rgba(255, 255, 255, 0.15);
        }

        body {
            overflow: hidden;
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            background: var(--bg-dark);
            color: var(--text);
        }

        /* Side Panel */
        #panel {
            position: absolute;
            top: 16px;
            right: 16px;
            bottom: 16px;
            width: 280px;
            background: var(--bg-panel);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid var(--border);
            border-radius: 16px;
            z-index: 100;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        #panel-header {
            padding: 20px;
            border-bottom: 1px solid var(--border);
        }

        #panel-header h1 {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-heading);
            margin-bottom: 4px;
        }

        #panel-header .subtitle {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        #panel-content {
            flex: 1;
            overflow-y: auto;
            padding: 12px;
        }

        /* Sections */
        .section {
            background: var(--bg-section);
            border-radius: 12px;
            padding: 14px;
            margin-bottom: 12px;
        }

        .section-title {
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: var(--text-muted);
            margin-bottom: 12px;
        }

        /* Controls */
        .control-row {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 10px;
        }

        .control-row:last-child {
            margin-bottom: 0;
        }

        .control-row label {
            display: flex;
            align-items: center;
            gap: 6px;
            cursor: pointer;
            font-size: 0.85rem;
        }

        .control-row input[type="checkbox"] {
            width: 16px;
            height: 16px;
            accent-color: var(--accent-primary);
        }

        .control-label {
            font-size: 0.75rem;
            color: var(--text-muted);
            min-width: 50px;
        }

        .input-group {
            display: flex;
            gap: 4px;
            flex: 1;
        }

        input[type="number"] {
            width: 100%;
            padding: 8px 6px;
            border-radius: 6px;
            border: 1px solid var(--border);
            background: rgba(0, 0, 0, 0.3);
            color: var(--text);
            font-size: 0.8rem;
            text-align: center;
        }

        input[type="number"]:focus {
            outline: none;
            border-color: var(--accent-primary);
        }

        .axis-label {
            position: absolute;
            top: 2px;
            left: 4px;
            font-size: 0.6rem;
            color: var(--text-muted);
            pointer-events: none;
        }

        .input-with-label {
            position: relative;
            flex: 1;
        }

        .input-with-label input {
            padding-top: 14px;
            padding-bottom: 4px;
        }

        /* Buttons */
        #panel-footer {
            padding: 16px;
            border-top: 1px solid var(--border);
        }

        .btn-group {
            display: flex;
            gap: 8px;
        }

        button {
            flex: 1;
            padding: 12px 16px;
            font-size: 0.85rem;
            font-weight: 500;
            cursor: pointer;
            border-radius: 8px;
            border: 1px solid var(--border);
            background: var(--accent);
            color: var(--text);
            transition: all 0.15s ease;
            font-family: inherit;
        }

        button:hover {
            background: var(--accent-hover);
            border-color: var(--accent-hover);
        }

        button.primary {
            background: var(--accent-primary);
            border-color: var(--accent-primary);
        }

        button.primary:hover {
            background: #3ba86e;
            border-color: #3ba86e;
        }

        #stats {
            margin-top: 12px;
            font-size: 0.75rem;
            color: var(--text-muted);
            text-align: center;
        }

        /* Canvas */
        canvas {
            display: block;
        }

        #svg-overlay {
            position: absolute;
            top: 0;
            left: 0;
            pointer-events: none;
        }

        /* Scrollbar */
        #panel-content::-webkit-scrollbar {
            width: 4px;
        }

        #panel-content::-webkit-scrollbar-track {
            background: transparent;
        }

        #panel-content::-webkit-scrollbar-thumb {
            background: var(--border-light);
            border-radius: 2px;
        }
    </style>
</head>

<body>
    <div id="panel">
        <div id="panel-header">
            <h1>Three Plotter</h1>
            <span class="subtitle">Hidden Line Renderer</span>
        </div>

        <div id="panel-content">
            <!-- Theme Section -->
            <div class="section">
                <div class="section-title">Theme</div>
                <div class="control-row">
                    <label><input type="radio" name="theme" id="themeDark" checked> Dark (white on black)</label>
                </div>
                <div class="control-row">
                    <label><input type="radio" name="theme" id="themeLight"> Light (black on white)</label>
                </div>
            </div>

            <!-- Layers Section -->
            <div class="section">
                <div class="section-title">Layers</div>
                <div class="control-row">
                    <label><input type="checkbox" id="showSilhouettes" checked> Silhouettes</label>
                </div>
                <div class="control-row">
                    <label><input type="checkbox" id="showEdges" checked> Edges</label>
                </div>
                <div class="control-row">
                    <label><input type="checkbox" id="showHatches" checked> Hatches</label>
                </div>
            </div>

            <!-- Hatching Section -->
            <div class="section">
                <div class="section-title">Hatching</div>
                <div class="control-row">
                    <span class="control-label">Rotation</span>
                    <div class="input-group">
                        <div class="input-with-label">
                            <span class="axis-label">X</span>
                            <input type="number" id="rotX" value="0" title="X Axis Rotation">
                        </div>
                        <div class="input-with-label">
                            <span class="axis-label">Y</span>
                            <input type="number" id="rotY" value="0" title="Y Axis Rotation">
                        </div>
                        <div class="input-with-label">
                            <span class="axis-label">Z</span>
                            <input type="number" id="rotZ" value="0" title="Z Axis Rotation">
                        </div>
                    </div>
                </div>
                <div class="control-row">
                    <span class="control-label">Spacing</span>
                    <div class="input-group">
                        <div class="input-with-label">
                            <span class="axis-label">X</span>
                            <input type="number" id="spaceX" value="8" step="1" title="X Axis Spacing">
                        </div>
                        <div class="input-with-label">
                            <span class="axis-label">Y</span>
                            <input type="number" id="spaceY" value="8" step="1" title="Y Axis Spacing">
                        </div>
                        <div class="input-with-label">
                            <span class="axis-label">Z</span>
                            <input type="number" id="spaceZ" value="8" step="1" title="Z Axis Spacing">
                        </div>
                    </div>
                </div>
                <div class="control-row">
                    <span class="control-label">Inset</span>
                    <div class="input-group">
                        <input type="number" id="insetPixels" value="2" step="1" min="0" title="Inset from edges (px)">
                    </div>
                </div>
                <div class="control-row">
                    <label><input type="checkbox" id="connectHatches"> Connect Lines</label>
                </div>

            </div>

            <!-- Lighting Section -->
            <div class="section">
                <div class="section-title">Lighting</div>
                <div class="control-row">
                    <label><input type="checkbox" id="brightnessShading" checked> Brightness Shading</label>
                </div>
                <div class="control-row">
                    <span class="control-label">Spacing</span>
                    <div class="input-group">
                        <div class="input-with-label">
                            <span class="axis-label">Min</span>
                            <input type="number" id="minSpacing" value="3" step="1" min="1" title="Min Spacing">
                        </div>
                        <div class="input-with-label">
                            <span class="axis-label">Max</span>
                            <input type="number" id="maxSpacing" value="40" step="1" min="1" title="Max Spacing">
                        </div>
                    </div>
                </div>
                <div class="control-row">
                    <span class="control-label">Position</span>
                    <div class="input-group">
                        <div class="input-with-label">
                            <span class="axis-label">X</span>
                            <input type="number" id="lightX" value="5" step="1" title="Light X">
                        </div>
                        <div class="input-with-label">
                            <span class="axis-label">Y</span>
                            <input type="number" id="lightY" value="5" step="1" title="Light Y">
                        </div>
                        <div class="input-with-label">
                            <span class="axis-label">Z</span>
                            <input type="number" id="lightZ" value="5" step="1" title="Light Z">
                        </div>
                    </div>
                </div>
                <div class="control-row">
                    <span class="control-label">Intensity</span>
                    <div class="input-group">
                        <input type="number" id="lightIntensity" value="1" step="0.1" min="0.1"
                            title="Light Intensity (affects contrast)">
                    </div>
                </div>
            </div>
        </div>

        <div id="panel-footer">
            <div class="btn-group">
                <button id="renderBtn" class="primary">Render</button>
                <button id="exportBtn">Export SVG</button>
            </div>
            <div id="stats">Use mouse to orbit. Click Render to generate.</div>
        </div>
    </div>

    <svg id="svg-overlay" xmlns="http://www.w3.org/2000/svg"></svg>

    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/examples/jsm/controls/OrbitControls.js';
        import { PlotterRenderer } from './src/plotter-renderer.js';

        let scene, camera, glRenderer, controls;
        let plotterRenderer;
        let primitives = [];
        let pointLight, pointLightHelper;
        let ambientLight;
        let gridHelper;

        const PANEL_WIDTH = 312; // 280px panel + 16px margin + 16px gap

        function init() {
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x222222);

            const sceneWidth = window.innerWidth - PANEL_WIDTH;

            camera = new THREE.PerspectiveCamera(45, sceneWidth / window.innerHeight, 1, 1000);
            camera.position.set(8, 6, 10);

            // WebGL renderer for 3D preview
            glRenderer = new THREE.WebGLRenderer({ antialias: true });
            glRenderer.setSize(sceneWidth, window.innerHeight);
            document.body.appendChild(glRenderer.domElement);

            // PlotterRenderer for SVG output
            plotterRenderer = new PlotterRenderer();
            plotterRenderer.setSize(sceneWidth, window.innerHeight);
            plotterRenderer.setGLRenderer(glRenderer);

            controls = new OrbitControls(camera, glRenderer.domElement);
            controls.enableDamping = true;
            controls.dampingFactor = 0.05;

            // Lighting
            ambientLight = new THREE.AmbientLight(0x404040);
            scene.add(ambientLight);

            // Point light with helper (for brightness-based hatching)
            // distance=0 means infinite range (no falloff limit)
            pointLight = new THREE.PointLight(0xffffff, 50, 0);
            pointLight.position.set(5, 5, 5);
            scene.add(pointLight);

            pointLightHelper = new THREE.PointLightHelper(pointLight, 0.125, 0xff8800);
            pointLightHelper.userData.excludeFromSVG = true; // Exclude from SVG but show in scene
            scene.add(pointLightHelper);

            // Materials - Flat shading for proper detection
            const material = new THREE.MeshPhongMaterial({
                color: 0x44aa88,
                flatShading: true,
                shininess: 0
            });

            // 1. Pyramid (X-axis/Z-axis faces mainly)
            const pyramidGeom = new THREE.ConeGeometry(1.5, 2.5, 4);
            const pyramid = new THREE.Mesh(pyramidGeom, material.clone());
            pyramid.material.color.set(0xff6644);
            pyramid.position.set(-4, 1.25, 0);
            scene.add(pyramid);
            primitives.push(pyramid);

            // 2. Cylinder (Sides are radial, Top is Y-axis)
            const cylinderGeom = new THREE.CylinderGeometry(1, 1, 2.5, 12);
            const cylinder = new THREE.Mesh(cylinderGeom, material.clone());
            cylinder.material.color.set(0x44ff66);
            cylinder.position.set(0, 1.25, 0);
            scene.add(cylinder);
            primitives.push(cylinder);

            // 3. Icosahedron (Multi-faceted)
            const icoGeom = new THREE.IcosahedronGeometry(1.5, 0);
            const sphere = new THREE.Mesh(icoGeom, material.clone());
            sphere.material.color.set(0x4466ff);
            sphere.position.set(4, 1.5, 0);
            scene.add(sphere);
            primitives.push(sphere);

            // Floor grid
            gridHelper = new THREE.GridHelper(20, 20, 0x444444, 0x333333);
            scene.add(gridHelper);

            // Event listeners
            window.addEventListener('resize', onResize);
            document.getElementById('renderBtn').addEventListener('click', render);
            document.getElementById('exportBtn').addEventListener('click', exportSVG);

            // Light position and intensity controls
            ['lightX', 'lightY', 'lightZ', 'lightIntensity'].forEach(id => {
                document.getElementById(id).addEventListener('input', updateLightPosition);
            });

            // Theme change - live update
            ['themeDark', 'themeLight'].forEach(id => {
                document.getElementById(id).addEventListener('change', updateTheme);
            });

            animate();
        }

        function updateTheme() {
            const isLightTheme = document.getElementById('themeLight').checked;
            scene.background = new THREE.Color(isLightTheme ? '#ffffff' : '#222222');
            ambientLight.intensity = isLightTheme ? 2.0 : 0.25;

            // Update grid colors for theme
            scene.remove(gridHelper);
            gridHelper = new THREE.GridHelper(
                20, 20,
                isLightTheme ? 0xcccccc : 0x444444,  // center line
                isLightTheme ? 0xdddddd : 0x333333   // grid lines
            );
            scene.add(gridHelper);
        }

        function updateLightPosition() {
            const x = parseFloat(document.getElementById('lightX').value) || 5;
            const y = parseFloat(document.getElementById('lightY').value) || 5;
            const z = parseFloat(document.getElementById('lightZ').value) || 5;
            const intensity = parseFloat(document.getElementById('lightIntensity').value) || 1;
            pointLight.position.set(x, y, z);
            pointLight.intensity = intensity;
            pointLightHelper.update();
        }

        function onResize() {
            const sceneWidth = window.innerWidth - PANEL_WIDTH;
            camera.aspect = sceneWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            glRenderer.setSize(sceneWidth, window.innerHeight);
            plotterRenderer.setSize(sceneWidth, window.innerHeight);
        }

        function exportSVG() {
            const svgContent = plotterRenderer.domElement.outerHTML;
            const blob = new Blob([svgContent], { type: 'image/svg+xml' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'primitives-hidden-lines.svg';
            a.click();
            URL.revokeObjectURL(url);
        }

        function render() {
            document.getElementById('stats').textContent = 'Rendering...';

            // Configure theme
            const isLightTheme = document.getElementById('themeLight').checked;
            plotterRenderer.theme = isLightTheme ? 'light' : 'dark';

            // Update scene background and ambient light for preview
            const themeColors = plotterRenderer.themes[plotterRenderer.theme];
            scene.background = new THREE.Color(themeColors.background);
            ambientLight.intensity = isLightTheme ? 2.0 : 0.25;  // Boost ambient in light mode

            // Configure PlotterRenderer from UI
            plotterRenderer.showSilhouettes = document.getElementById('showSilhouettes').checked;
            plotterRenderer.showEdges = document.getElementById('showEdges').checked;
            plotterRenderer.showHatches = document.getElementById('showHatches').checked;

            // Configure hatch settings from UI inputs
            plotterRenderer.hatchOptions.axisSettings = {
                x: {
                    rotation: parseFloat(document.getElementById('rotX').value) || 0,
                    spacing: parseFloat(document.getElementById('spaceX').value) || 8
                },
                y: {
                    rotation: parseFloat(document.getElementById('rotY').value) || 0,
                    spacing: parseFloat(document.getElementById('spaceY').value) || 8
                },
                z: {
                    rotation: parseFloat(document.getElementById('rotZ').value) || 0,
                    spacing: parseFloat(document.getElementById('spaceZ').value) || 8
                }
            };

            // Configure brightness shading (auto-invert based on theme)
            plotterRenderer.hatchOptions.brightnessShading = {
                enabled: document.getElementById('brightnessShading').checked,
                invert: !isLightTheme,  // Dark theme = invert (bright faces get fewer hatches)
                intensity: parseFloat(document.getElementById('lightIntensity').value) || 1
            };

            // Configure min/max spacing and inset for brightness-based hatching
            plotterRenderer.hatchOptions.minSpacing = parseFloat(document.getElementById('minSpacing').value) || 3;
            plotterRenderer.hatchOptions.maxSpacing = parseFloat(document.getElementById('maxSpacing').value) || 40;
            const insetVal = parseFloat(document.getElementById('insetPixels').value);
            plotterRenderer.hatchOptions.insetPixels = isNaN(insetVal) ? 2 : insetVal;
            plotterRenderer.hatchOptions.connectHatches = document.getElementById('connectHatches').checked;


            // Update matrices
            primitives.forEach(m => m.updateMatrixWorld(true));

            setTimeout(() => {
                const startTime = performance.now();

                // Clear and render using PlotterRenderer
                plotterRenderer.clear();
                plotterRenderer.renderGPULayers(scene, camera);

                // Copy to SVG overlay
                const svgOverlay = document.getElementById('svg-overlay');
                const sceneWidth = window.innerWidth - PANEL_WIDTH;
                svgOverlay.innerHTML = plotterRenderer.domElement.innerHTML;
                svgOverlay.setAttribute('width', sceneWidth);
                svgOverlay.setAttribute('height', window.innerHeight);
                svgOverlay.setAttribute('viewBox', plotterRenderer.domElement.getAttribute('viewBox'));

                const elapsed = performance.now() - startTime;
                document.getElementById('stats').textContent = `Render completed in ${elapsed.toFixed(0)}ms`;
            }, 50);
        }

        function animate() {
            requestAnimationFrame(animate);
            controls.update();
            glRenderer.render(scene, camera);
        }

        init();
    </script>
</body>

</html>